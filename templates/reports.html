{% extends "base.html" %}

{% block title %}Reports & Analytics - Student Records{% endblock %}

{% block content %}
<!-- Statistics Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-users fa-2x mb-2"></i>
                <h3>{{ report_data.total_students }}</h3>
                <p class="mb-0">Total Students</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-book fa-2x mb-2"></i>
                <h3>{{ report_data.total_courses }}</h3>
                <p class="mb-0">Total Courses</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <h3>{{ "%.1f"|format(report_data.overall_avg) }}</h3>
                <p class="mb-0">Overall Average</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <h3>{{ report_data.low_performers|length }}</h3>
                <p class="mb-0">Need Attention</p>
            </div>
        </div>
    </div>
</div>

<!-- Grade Distribution Chart -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Grade Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="gradeChart" width="400" height="200"></canvas>
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col">
                            <span class="badge bg-success">A (90+)</span><br>
                            <strong>{{ report_data.grade_distribution.A }}</strong>
                        </div>
                        <div class="col">
                            <span class="badge bg-info">B (80-89)</span><br>
                            <strong>{{ report_data.grade_distribution.B }}</strong>
                        </div>
                        <div class="col">
                            <span class="badge bg-warning">C (70-79)</span><br>
                            <strong>{{ report_data.grade_distribution.C }}</strong>
                        </div>
                        <div class="col">
                            <span class="badge bg-orange">D (60-69)</span><br>
                            <strong>{{ report_data.grade_distribution.D }}</strong>
                        </div>
                        <div class="col">
                            <span class="badge bg-danger">F (<60)</span><br>
                            <strong>{{ report_data.grade_distribution.F }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Course Statistics -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-book me-2"></i>Course Performance
                </h5>
            </div>
            <div class="card-body">
                <canvas id="courseChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Top Performers -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-trophy me-2 text-warning"></i>Top Performers
                </h5>
            </div>
            <div class="card-body">
                {% if report_data.top_performers %}
                    <div class="table-responsive">
                        <table class="table table-dark table-sm">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Name</th>
                                    <th>Roll No</th>
                                    <th>Avg Grade</th>
                                    <th>Courses</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in report_data.top_performers %}
                                <tr>
                                    <td>
                                        {% if loop.index == 1 %}
                                            <i class="fas fa-crown text-warning"></i>
                                        {% elif loop.index == 2 %}
                                            <i class="fas fa-medal text-secondary"></i>
                                        {% elif loop.index == 3 %}
                                            <i class="fas fa-medal text-warning"></i>
                                        {% else %}
                                            {{ loop.index }}
                                        {% endif %}
                                    </td>
                                    <td><strong>{{ student.name }}</strong></td>
                                    <td><span class="badge bg-primary">{{ student.roll_no }}</span></td>
                                    <td>
                                        <span class="badge bg-{% if student.avg_grade >= 95 %}success{% elif student.avg_grade >= 90 %}info{% else %}warning{% endif %}">
                                            {{ student.avg_grade }}
                                        </span>
                                    </td>
                                    <td><span class="badge bg-secondary">{{ student.courses|length }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted text-center">No students found</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Students Needing Attention -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>Students Needing Attention
                </h5>
            </div>
            <div class="card-body">
                {% if report_data.low_performers %}
                    <div class="table-responsive">
                        <table class="table table-dark table-sm">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Roll No</th>
                                    <th>Avg Grade</th>
                                    <th>Courses</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in report_data.low_performers %}
                                <tr>
                                    <td><strong>{{ student.name }}</strong></td>
                                    <td><span class="badge bg-primary">{{ student.roll_no }}</span></td>
                                    <td>
                                        <span class="badge bg-{% if student.avg_grade >= 60 %}warning{% else %}danger{% endif %}">
                                            {{ student.avg_grade }}
                                        </span>
                                    </td>
                                    <td><span class="badge bg-secondary">{{ student.courses|length }}</span></td>
                                    <td>
                                        <a href="{{ url_for('edit_student', roll_no=student.roll_no) }}" 
                                           class="btn btn-outline-warning btn-sm" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-success text-center">
                        <i class="fas fa-check-circle me-1"></i>
                        All students are performing well!
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Detailed Course Statistics -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Detailed Course Statistics
                </h5>
            </div>
            <div class="card-body">
                {% if report_data.course_stats %}
                    <div class="table-responsive">
                        <table class="table table-dark table-striped">
                            <thead>
                                <tr>
                                    <th>Course</th>
                                    <th>Enrolled Students</th>
                                    <th>Average Grade</th>
                                    <th>Performance</th>
                                    <th>Grade Distribution</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for course, stats in report_data.course_stats.items() %}
                                <tr>
                                    <td><strong>{{ course }}</strong></td>
                                    <td>
                                        <span class="badge bg-primary">{{ stats.total_students }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if stats.avg_grade >= 90 %}success{% elif stats.avg_grade >= 80 %}info{% elif stats.avg_grade >= 70 %}warning{% else %}danger{% endif %}">
                                            {{ stats.avg_grade }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if stats.avg_grade >= 90 %}
                                            <span class="text-success"><i class="fas fa-arrow-up"></i> Excellent</span>
                                        {% elif stats.avg_grade >= 80 %}
                                            <span class="text-info"><i class="fas fa-arrow-up"></i> Good</span>
                                        {% elif stats.avg_grade >= 70 %}
                                            <span class="text-warning"><i class="fas fa-minus"></i> Average</span>
                                        {% else %}
                                            <span class="text-danger"><i class="fas fa-arrow-down"></i> Needs Improvement</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 8px;">
                                            {% set total_grades = stats.total_students %}
                                            {% set excellent = stats.total_grade // 90 %}
                                            {% set good = (stats.total_grade - excellent * 90) // 80 %}
                                            {% set average = (stats.total_grade - excellent * 90 - good * 80) // 70 %}
                                            
                                            <div class="progress-bar bg-success" role="progressbar" 
                                                 style="width: {{ (excellent / total_grades * 100) if total_grades > 0 else 0 }}%"></div>
                                            <div class="progress-bar bg-info" role="progressbar" 
                                                 style="width: {{ (good / total_grades * 100) if total_grades > 0 else 0 }}%"></div>
                                            <div class="progress-bar bg-warning" role="progressbar" 
                                                 style="width: {{ (average / total_grades * 100) if total_grades > 0 else 0 }}%"></div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted text-center">No course data available</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Export Options -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-download me-1"></i>Export Options
                </h6>
            </div>
            <div class="card-body">
                <div class="btn-group" role="group">
                    <a href="{{ url_for('export_data') }}" class="btn btn-outline-success">
                        <i class="fas fa-file-export me-1"></i>Export All Data (JSON)
                    </a>
                    <button class="btn btn-outline-info" onclick="window.print()">
                        <i class="fas fa-print me-1"></i>Print Report
                    </button>
                    <button class="btn btn-outline-secondary" onclick="downloadCharts()">
                        <i class="fas fa-chart-bar me-1"></i>Download Charts
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Grade Distribution Pie Chart
const gradeCtx = document.getElementById('gradeChart').getContext('2d');
const gradeChart = new Chart(gradeCtx, {
    type: 'doughnut',
    data: {
        labels: ['A (90+)', 'B (80-89)', 'C (70-79)', 'D (60-69)', 'F (<60)'],
        datasets: [{
            data: [
                {{ report_data.grade_distribution.A }},
                {{ report_data.grade_distribution.B }},
                {{ report_data.grade_distribution.C }},
                {{ report_data.grade_distribution.D }},
                {{ report_data.grade_distribution.F }}
            ],
            backgroundColor: [
                '#198754', // success
                '#0dcaf0', // info
                '#ffc107', // warning
                '#fd7e14', // orange
                '#dc3545'  // danger
            ],
            borderWidth: 2,
            borderColor: '#2d3748'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    color: '#e2e8f0',
                    usePointStyle: true,
                    padding: 15
                }
            }
        }
    }
});

// Course Performance Bar Chart
const courseCtx = document.getElementById('courseChart').getContext('2d');
const courseLabels = [
    {% for course, stats in report_data.course_stats.items() %}
        '{{ course }}',
    {% endfor %}
];
const courseData = [
    {% for course, stats in report_data.course_stats.items() %}
        {{ stats.avg_grade }},
    {% endfor %}
];

const courseChart = new Chart(courseCtx, {
    type: 'bar',
    data: {
        labels: courseLabels,
        datasets: [{
            label: 'Average Grade',
            data: courseData,
            backgroundColor: courseData.map(grade => {
                if (grade >= 90) return '#198754'; // success
                if (grade >= 80) return '#0dcaf0'; // info
                if (grade >= 70) return '#ffc107'; // warning
                return '#dc3545'; // danger
            }),
            borderColor: '#2d3748',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: {
                    color: '#e2e8f0'
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                grid: {
                    color: '#4a5568'
                },
                ticks: {
                    color: '#e2e8f0'
                }
            },
            x: {
                grid: {
                    color: '#4a5568'
                },
                ticks: {
                    color: '#e2e8f0'
                }
            }
        }
    }
});

// Download charts function
function downloadCharts() {
    // Create a temporary canvas to combine charts
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = 800;
    canvas.height = 600;
    
    // Set dark background
    ctx.fillStyle = '#1a1d23';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Add title
    ctx.fillStyle = '#e2e8f0';
    ctx.font = 'bold 20px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Student Records Report - Charts', canvas.width / 2, 30);
    
    // Convert grade chart to image and draw
    const gradeImage = document.getElementById('gradeChart').toDataURL();
    const gradeImg = new Image();
    gradeImg.onload = function() {
        ctx.drawImage(gradeImg, 50, 50, 300, 200);
        
        // Convert course chart to image and draw
        const courseImage = document.getElementById('courseChart').toDataURL();
        const courseImg = new Image();
        courseImg.onload = function() {
            ctx.drawImage(courseImg, 400, 50, 300, 200);
            
            // Download the combined image
            const link = document.createElement('a');
            link.download = 'student_records_charts.png';
            link.href = canvas.toDataURL();
            link.click();
        };
        courseImg.src = courseImage;
    };
    gradeImg.src = gradeImage;
}

// Auto-refresh data every 60 seconds
setInterval(function() {
    location.reload();
}, 60000);
</script>
{% endblock %}
